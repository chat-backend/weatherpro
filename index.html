<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>WeatherPro Chat</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    #chatbox { width: 100%; height: 400px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; }
    #input { width: 80%; padding: 10px; }
    #send { padding: 10px; }
    #hint { font-size: 0.9em; color: #555; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>üó£Ô∏è WeatherPro Vietnam ‚Äî Khung Chat</h2>
  <div id="chatbox"></div>
  <input type="text" id="input" placeholder="Nh·∫≠p t√™n t·ªânh/th√†nh ho·∫∑c ph∆∞·ªùng/x√£..." />
  <button id="send">G·ª≠i</button>
  <div id="hint">V√≠ d·ª•: TP. H√† N·ªôi, Qu·∫£ng Ng√£i, X√£ L√£nh Ng·ªçc, Ph∆∞·ªùng H·∫£i Ch√¢u...</div>

  <script>
    const chatbox = document.getElementById("chatbox");
    const input = document.getElementById("input");
    const send = document.getElementById("send");

    // H√†m chu·∫©n h√≥a: lo·∫°i b·ªè t·ª´ th·ª´a
    function normalizeRegion(text) {
      const stopwords = ["th·ªùi ti·∫øt", "h√¥m nay", "ng√†y mai", "·ªü", "t·∫°i"];
      let region = text.toLowerCase();
      stopwords.forEach(w => {
        region = region.replace(w, "");
      });
      return region.trim();
    }

    send.onclick = async () => {
      const message = input.value.trim();
      if (!message) return;

      chatbox.innerHTML += `<p><strong>B·∫°n:</strong> ${message}</p>`;
      input.value = "";

      // Chu·∫©n h√≥a input ƒë·ªÉ l·∫•y t√™n v√πng
      const region = normalizeRegion(message);

      try {
        const res = await fetch(`http://localhost:8000/v1/chat?region=${encodeURIComponent(region)}`);
        if (!res.ok) throw new Error("L·ªói k·∫øt n·ªëi API");
        const data = await res.json();

        if (data.error) {
          chatbox.innerHTML += `<p><strong>WeatherPro:</strong><br>${data.error}</p>`;
        } else {
          chatbox.innerHTML += `<p><strong>WeatherPro:</strong><br>${data.bulletin.replace(/\n/g, "<br>")}</p>`;
        }
      } catch (err) {
        chatbox.innerHTML += `<p><strong>WeatherPro:</strong><br>‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt. ${err.message}</p>`;
      }

      chatbox.scrollTop = chatbox.scrollHeight;
    };

    // Cho ph√©p b·∫•m Enter ƒë·ªÉ g·ª≠i
    input.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        send.click();
      }
    });
  </script>
</body>
</html>